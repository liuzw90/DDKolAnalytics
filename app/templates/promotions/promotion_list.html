{% extends 'base.html' %}

{% block title %}推广管理 - 抖音达人数据分析系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">推广数据列表</h5>
                    <div class="card-tools">
                        {% if current_user.role == 'business' or current_user.role == 'pitcher' %}
                        <a href="{{ url_for('promotions.add_promotion') }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> 添加推广数据
                        </a>
                        <button id="batch-fetch-btn" class="btn btn-sm btn-info ml-2">
                            <i class="fas fa-sync"></i> 批量获取数据
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>推广名称</th>
                                    <th>达人名称</th>
                                    <th>素材ID</th>
                                    <th>投放时间</th>
                                    <th>曝光量</th>
                                    <th>点击量</th>
                                    <th>转化率</th>
                                    <th>ROI</th>
                                    <th>创建人</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for promotion in promotions.items %}
                                <tr>
                                    <td>{{ promotion.id }}</td>
                                    <td>{{ promotion.name }}</td>
                                    <td>
                                        {% if promotion.influencer %}
                                        <a href="{{ url_for('influencers.influencer_detail', influencer_id=promotion.influencer.id) }}">
                                            {{ promotion.influencer.name }}
                                        </a>
                                        {% else %}
                                        未关联
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if promotion.material %}
                                        <a href="{{ url_for('influencers.material_detail', material_id=promotion.material.id) }}">
                                            {{ promotion.material.material_id }}
                                        </a>
                                        {% else %}
                                        未关联
                                        {% endif %}
                                    </td>
                                    <td>{{ promotion.promotion_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ promotion.exposure_count }}</td>
                                    <td>{{ promotion.click_count }}</td>
                                    <td>{{ "%.2f%%"|format(promotion.conversion_rate * 100) if promotion.conversion_rate else '0.00%' }}</td>
                                    <td>{{ "%.2f"|format(promotion.roi) if promotion.roi else '0.00' }}</td>
                                    <td>{{ promotion.created_by_user.username if promotion.created_by_user else '系统' }}</td>
                                    <td>
                                        <a href="{{ url_for('promotions.promotion_detail', promotion_id=promotion.id) }}" class="btn btn-sm btn-info">
                                            详情
                                        </a>
                                        {% if (current_user.role == 'business' and promotion.created_by == current_user.id) or current_user.role == 'pitcher' %}
                                        <a href="{{ url_for('promotions.edit_promotion', promotion_id=promotion.id) }}" class="btn btn-sm btn-primary ml-1">
                                            编辑
                                        </a>
                                        <a href="{{ url_for('promotions.delete_promotion', promotion_id=promotion.id) }}" class="btn btn-sm btn-danger ml-1">
                                            删除
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="11" class="text-center">暂无推广数据</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页导航 -->
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item {% if not promotions.has_prev %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('promotions.promotion_list', page=promotions.prev_num) if promotions.has_prev else '#' }}">
                                    &laquo;
                                </a>
                            </li>
                            {% for page_num in promotions.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                {% if page_num %}
                                <li class="page-item {% if page_num == promotions.page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('promotions.promotion_list', page=page_num) }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}
                            <li class="page-item {% if not promotions.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('promotions.promotion_list', page=promotions.next_num) if promotions.has_next else '#' }}">
                                    &raquo;
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('batch-fetch-btn').addEventListener('click', function() {
        if (confirm('确定要从抖音API批量获取推广数据吗？这可能需要一些时间。')) {
            window.location.href = '{{ url_for('promotions.batch_fetch_promotions') }}';
        }
    });
</script>
{% endblock %}